# 卡牌系统文档

## 概述

本文档详细描述了游戏中的卡牌系统，采用面向对象的设计模式，遵循SOLID原则，特别是单一职责原则和开闭原则。

## 基础架构

### BaseCard 基类

**文件位置**: [`Scripts/selections/BaseCard.gd`](Scripts/selections/BaseCard.gd:1)

**类名**: `BaseCard`

**继承**: `RefCounted`

**职责**: 定义所有卡牌的通用接口和行为

#### 核心属性

| 属性名 | 类型 | 默认值 | 描述 |
|--------|------|--------|------|
| `card_name` | `String` | `""` | 卡牌名称 |
| `description` | `String` | `""` | 卡牌描述 |
| `icon_path` | `String` | `""` | 卡牌图标路径 |
| `card_tag` | `String` | `"basic"` | 卡牌标签，用于分组 |
| `is_enabled` | `bool` | `true` | 卡牌是否启用 |

#### 核心方法

| 方法名 | 返回类型 | 描述 |
|--------|----------|------|
| `initialize()` | `void` | 初始化卡牌（虚函数，子类必须实现） |
| `apply_effect()` | `void` | 应用卡牌效果（虚函数，子类必须实现） |
| `get_display_text()` | `String` | 获取卡牌显示文本 |
| `get_card_name()` | `String` | 获取卡牌名称 |
| `get_icon_path()` | `String` | 获取卡牌图标路径 |
| `can_apply()` | `bool` | 检查卡牌是否可以应用 |
| `on_before_apply()` | `void` | 卡牌应用前的回调（可选重写） |
| `on_after_apply()` | `void` | 卡牌应用后的回调（可选重写） |

#### 标签管理方法

| 方法名 | 返回类型 | 描述 |
|--------|----------|------|
| `has_tag(tag: String)` | `bool` | 检查是否具有指定标签 |
| `set_tag(tag: String)` | `void` | 设置卡牌标签 |
| `get_tag()` | `String` | 获取卡牌标签 |
| `set_enabled(enabled: bool)` | `void` | 设置卡牌启用状态 |
| `is_tag_in_list(tags: Array[String])` | `bool` | 检查标签是否在指定列表中 |

## 卡牌分类

### 1. 基础卡牌 (Basic)

标签: `"basic"`

#### 1.1 子弹伤害提升卡牌

**类名**: `BulletDamageCard`

**文件位置**: [`Scripts/selections/selections_cards/Basic/BulletDamageCard.gd`](Scripts/selections/selections_cards/Basic/BulletDamageCard.gd:1)

**继承**: `BaseCard`

**功能**: 提升子弹伤害

| 属性名 | 类型 | 默认值 | 描述 |
|--------|------|--------|------|
| `damage_coefficient` | `float` | `1.5` | 伤害系数 |

**效果**: 子弹伤害乘以 `damage_coefficient`

**信号**: [`SignalBus.Sel_Bullet_damage.emit(damage_coefficient)`](Scripts/manager/SignalBus.gd:19)

**使用示例**:
```gdscript
var card = BulletDamageCard.new()
card.apply_effect()  # 子弹伤害提升1.5倍
```

#### 1.2 开火速率提升卡牌

**类名**: `BulletFireRateCard`

**文件位置**: [`Scripts/selections/selections_cards/Basic/BulletFireRateCard.gd`](Scripts/selections/selections_cards/Basic/BulletFireRateCard.gd:1)

**继承**: `BaseCard`

**功能**: 提升开火速率（减少开火间隔时间）

| 属性名 | 类型 | 默认值 | 描述 |
|--------|------|--------|------|
| `fire_rate_coefficient` | `float` | `0.75` | 开火时间系数 |

**效果**: 开火时间乘以 `fire_rate_coefficient`（数值越小，开火越快）

**信号**: [`SignalBus.Sel_Bullet_fire_timer.emit(fire_rate_coefficient)`](Scripts/manager/SignalBus.gd:20)

**使用示例**:
```gdscript
var card = BulletFireRateCard.new()
card.apply_effect()  # 开火时间减少到原来的0.75倍
```

#### 1.3 经验获取提升卡牌

**类名**: `ExpGainCard`

**文件位置**: [`Scripts/selections/selections_cards/Basic/ExpGainCard.gd`](Scripts/selections/selections_cards/Basic/ExpGainCard.gd:1)

**继承**: `BaseCard`

**功能**: 提升经验获取倍率

| 属性名 | 类型 | 默认值 | 描述 |
|--------|------|--------|------|
| `exp_coefficient` | `float` | `2.0` | 经验系数 |

**效果**: 经验获取乘以 `exp_coefficient`

**信号**: [`SignalBus.Sel_Exp_obtain.emit(exp_coefficient)`](Scripts/manager/SignalBus.gd:21)

**使用示例**:
```gdscript
var card = ExpGainCard.new()
card.apply_effect()  # 经验获取提升2倍
```

### 2. 追踪子弹卡牌 (TrackingBullet)

标签: `"tracking_bullet"`

#### 2.1 追踪子弹最大生存时间提升卡牌

**类名**: `TrackingBulletMaxLifetimeCard`

**文件位置**: [`Scripts/selections/selections_cards/TrackingBullet/TrackingBulletMaxLifetimeCard.gd`](Scripts/selections/selections_cards/TrackingBullet/TrackingBulletMaxLifetimeCard.gd:1)

**继承**: `BaseCard`

**功能**: 增加追踪子弹的最大生存时间

| 属性名 | 类型 | 默认值 | 描述 |
|--------|------|--------|------|
| `max_lifetime_increase` | `float` | `0.2` | 最大生存时间增加值（秒） |

**效果**: 追踪子弹最大生存时间增加 `max_lifetime_increase` 秒

**信号**: [`SignalBus.Sel_Tracking_Bullet_Max_Lifetime.emit(max_lifetime_increase)`](Scripts/manager/SignalBus.gd:25)

**使用示例**:
```gdscript
var card = TrackingBulletMaxLifetimeCard.new()
card.apply_effect()  # 追踪子弹最大生存时间增加0.2秒
```

#### 2.2 追踪子弹转向速度提升卡牌

**类名**: `TrackingBulletTurnSpeedCard`

**文件位置**: [`Scripts/selections/selections_cards/TrackingBullet/TrackingBulletTurnSpeedCard.gd`](Scripts/selections/selections_cards/TrackingBullet/TrackingBulletTurnSpeedCard.gd:1)

**继承**: `BaseCard`

**功能**: 提升追踪子弹的转向速度

| 属性名 | 类型 | 默认值 | 描述 |
|--------|------|--------|------|
| `turn_speed_coefficient` | `float` | `1.1` | 转向速度系数 |

**效果**: 追踪子弹转向速度乘以 `turn_speed_coefficient`

**信号**: [`SignalBus.Sel_Tracking_Bullet_Turn_Speed.emit(turn_speed_coefficient)`](Scripts/manager/SignalBus.gd:24)

**使用示例**:
```gdscript
var card = TrackingBulletTurnSpeedCard.new()
card.apply_effect()  # 追踪子弹转向速度提升1.1倍
```

## 设计模式与原则

### 1. 单一职责原则 (SRP)

每个卡牌类只负责一种特定的游戏效果：
- `BulletDamageCard` 只负责伤害提升
- `BulletFireRateCard` 只负责开火速率提升
- `ExpGainCard` 只负责经验获取提升
- `TrackingBulletMaxLifetimeCard` 只负责追踪子弹生存时间
- `TrackingBulletTurnSpeedCard` 只负责追踪子弹转向速度

### 2. 开闭原则 (OCP)

系统对扩展开放，对修改关闭：
- 新增卡牌只需继承 `BaseCard` 并实现必要方法
- 无需修改现有代码即可添加新功能
- 通过标签系统实现卡牌分类，便于扩展

### 3. 里氏替换原则 (LSP)

所有子类都可以替换基类使用：
- 任何使用 `BaseCard` 的地方都可以使用其子类
- 子类完全兼容基类的接口约定

### 4. 接口隔离原则 (ISP)

`BaseCard` 提供了最小化的接口，子类只需实现必要的方法：
- `initialize()` 和 `apply_effect()` 是必须实现的
- 其他方法如 `can_apply()`、`on_before_apply()` 等提供了默认实现

### 5. 依赖倒置原则 (DIP)

高层模块不依赖低层模块，都依赖于抽象：
- 卡牌系统通过信号总线 (`SignalBus`) 与游戏其他部分通信
- 避免了直接依赖具体的游戏管理器类

## 信号系统

卡牌系统使用信号总线模式进行通信，详见 [`SignalBus.gd`](Scripts/manager/SignalBus.gd:1)

### 卡牌相关信号

| 信号名 | 参数 | 描述 |
|--------|------|------|
| `Sel_Bullet_damage` | `cof: float` | 子弹伤害系数 |
| `Sel_Bullet_fire_timer` | `cof: float` | 开火时间系数 |
| `Sel_Exp_obtain` | `cof: float` | 经验获取系数 |
| `Sel_Tracking_Bullet_Turn_Speed` | `cof: float` | 追踪子弹转向速度系数 |
| `Sel_Tracking_Bullet_Max_Lifetime` | `increase: float` | 追踪子弹最大生存时间增加值 |

## 扩展指南

### 添加新卡牌

1. 创建新的卡牌类，继承 `BaseCard`
2. 实现 `initialize()` 和 `apply_effect()` 方法
3. 在 `SignalBus` 中添加相应的信号（如需要）
4. 在 `CardFactory` 中注册新卡牌（如存在）

### 示例：添加新卡牌

```gdscript
# 新卡牌：移动速度提升
class_name MovementSpeedCard
extends BaseCard

var speed_coefficient: float = 1.2

func _init():
    card_name = "移动速度提升"
    description = "移动速度*1.2"
    icon_path = ""
    card_tag = "basic"  # 或其他合适的标签

func initialize() -> void:
    speed_coefficient = 1.2
    description = "移动速度*" + str(speed_coefficient)

func apply_effect() -> void:
    on_before_apply()
    SignalBus.Sel_Movement_Speed.emit(speed_coefficient)  # 需要在SignalBus中添加此信号
    on_after_apply()
```

## 最佳实践

1. **保持一致性**: 所有卡牌遵循相同的命名约定和结构
2. **使用标签**: 合理使用标签系统对卡牌进行分类
3. **信号通信**: 通过信号总线进行模块间通信，避免直接依赖
4. **文档更新**: 添加新卡牌时及时更新文档
5. **测试覆盖**: 为每个卡牌编写单元测试

## 总结

卡牌系统采用了良好的面向对象设计，遵循SOLID原则，具有高度的可扩展性和可维护性。通过继承、多态和信号机制，实现了松耦合的模块化架构，便于后续功能扩展和维护。